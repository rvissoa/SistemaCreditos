@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
<!-- Main content -->
<section class="content" id="asistencia">

    <!-- Default box -->
    <div class="card card-solid">
        <div class="card-body pb-0">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <a onclick="location.reload();" class="btn btn-sm btn-default" title="Refrescar">
                        <i class="fas fa-2x fa-sync-alt"></i>&nbsp;
                    </a>
                </div>

            </div>
            <br />
            <div class="row">
                @{
                    //Zona horaria
                    DateTime timeUtc = DateTime.UtcNow;
                    TimeZoneInfo cstZone = TimeZoneInfo.FindSystemTimeZoneById("SA Pacific Standard Time");
                    DateTime DateLima = TimeZoneInfo.ConvertTimeFromUtc(timeUtc, cstZone);
                }
                <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch flex-column">
                    <div class="card bg-gradient-cyan d-flex flex-fill">
                        <div class="card-body pt-0">
                            <div class="row">
                                <div class="row" v-if="HoraEntrada!=''">
                                    <div class="col-7">
                                        <br />
                                        <h2 class="lead"><b>ENTRADA REGISTRADA </b></h2>
                                        <hr />
                                        <ul class="ml-4 mb-0 fa-ul text-white">
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-calendar"></i></span>Día: <b> {{FechaAsistencia}}</b>  </li>
                                            <br />
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-clock"></i></span> Hora: <b> {{HoraEntrada}}</b> </li>
                                        </ul>
                                    </div>
                                    <div class="col-5 text-center">
                                        <br><br><br>
                                        <i class="fas fa-4x fa-check"></i>
                                    </div>
                                </div>
                                <div v-else>
                                    <div class="col-7">
                                        <br />
                                        <h2 class="lead"><b>MARCAR ENTRADA</b></h2>
                                        <hr />
                                        <ul class="ml-4 mb-0 fa-ul text-white">
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-calendar"></i></span>Día: <b> @DateLima.Date.ToString("dd/MMM/yyyy")</b>  </li>
                                            <br />
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-clock"></i></span> Hora: <b> @DateLima.Hour : @DateTime.Now.Minute</b> </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="text-right">
                                <a v-on:Click="marcarAsistencia" class="btn btn-sm btn-default entrada">
                                    <i class="fas fa-save"></i>&nbsp; Registrar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch flex-column">
                    <div class="card bg-gradient-yellow d-flex flex-fill">
                        <div class="card-body pt-0">
                            <div class="row">
                                @if (ViewBag.HoraAlmuerzo != null)
                                {
                                    <div class="col-7">
                                        <br />
                                        <h2 class="lead"><b>ALMUERZO REGISTRADO</b></h2>
                                        <hr />
                                        <ul class="ml-4 mb-0 fa-ul text-muted">
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-calendar"></i></span>Día: <b>  @ViewBag.FechaAsistencia</b>  </li>
                                            <br />
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-clock"></i></span> Hora: <b> @ViewBag.HoraAlmuerzo</b> </li>
                                        </ul>
                                    </div>
                                    <div class="col-5 text-center">
                                        <br><br><br><br>
                                        <i class="fas fa-4x fa-check "></i>
                                    </div>
                                }
                                else
                                {
                                    <div class="col-7">
                                        <br />
                                        <h2 class="lead"><b>MARCAR ALMUERZO</b></h2>
                                        <hr />
                                        <ul class="ml-4 mb-0 fa-ul text-muted">
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-calendar"></i></span>Día: <b> @DateLima.Date.ToString("dd/MMM/yyyy")</b>  </li>
                                            <br />
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-clock"></i></span> Hora: <b> @DateLima.Hour : @DateTime.Now.Minute</b> </li>
                                        </ul>
                                    </div>
                                }

                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="text-right">
                                <a v-on:Click="marcarAlmuerzo" class="btn btn-sm btn-default">
                                    <i class="fas fa-save"></i>&nbsp; Registrar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch flex-column">
                    <div class="card bg-gradient-yellow d-flex flex-fill">
                        <div class="card-body pt-0">
                            <div class="row">
                                @if (ViewBag.HoraAlmuerzoRegreso != null)
                                {
                                    <div class="col-7">
                                        <br />
                                        <h2 class="lead"><b>REGRESO ALMUERZO REGISTRADO</b></h2>
                                        <hr />
                                        <ul class="ml-4 mb-0 fa-ul text-muted">
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-calendar"></i></span>Día: <b> @ViewBag.FechaAsistencia</b>  </li>
                                            <br />
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-clock"></i></span> Hora: <b> @ViewBag.HoraAlmuerzoRegreso</b> </li>
                                        </ul>
                                    </div>
                                    <div class="col-5 text-center">
                                        <br><br><br><br>
                                        <i class="fas fa-4x fa-check"></i>
                                    </div>
                                }
                                else
                                {
                                    <div class="col-7">
                                        <br />
                                        <h2 class="lead"><b>REGRESO ALMUERZO</b></h2>
                                        <hr />
                                        <ul class="ml-4 mb-0 fa-ul text-muted">
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-calendar"></i></span>Día: <b> @DateLima.Date.ToString("dd/MMM/yyyy")</b>  </li>
                                            <br />
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-clock"></i></span> Hora: <b> @DateLima.Hour : @DateTime.Now.Minute</b> </li>
                                        </ul>
                                    </div>
                                }

                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="text-right">
                                <a v-on:Click="marcarAlmuerzoRegreso" class="btn btn-sm btn-default">
                                    <i class="fas fa-save"></i>&nbsp; Registrar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch flex-column"></div>
                <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch flex-column">
                    <div class="card bg-gradient-indigo d-flex flex-fill">
                        <div class="card-body pt-0">
                            <div class="row">
                                @if (ViewBag.HoraSalida != null)
                                {
                                    <div class="col-7">
                                        <br />
                                        <h2 class="lead"><b>SALIDA REGISTRADA</b></h2>
                                        <hr />
                                        <ul class="ml-4 mb-0 fa-ul text-white">
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-calendar"></i></span>Día: <b> @ViewBag.FechaAsistencia</b>  </li>
                                            <br />
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-clock"></i></span> Hora: <b>@ViewBag.HoraSalida</b> </li>
                                        </ul>
                                    </div>
                                    <div class="col-5 text-center">
                                        <br><br><br><br>
                                        <i class="fas fa-4x fa-check"></i>
                                    </div>
                                }
                                else
                                {
                                    <div class="col-7">
                                        <br />
                                        <h2 class="lead"><b>MARCAR SALIDA</b></h2>
                                        <hr />
                                        <ul class="ml-4 mb-0 fa-ul text-white">
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-calendar"></i></span>Día: <b> @DateLima.Date.ToString("dd/MMM/yyyy")</b>  </li>
                                            <br />
                                            <li class="l-1"><span class="fa-li"><i class="fas fa-lg fa-clock"></i></span> Hora: <b> @DateLima.Hour : @DateTime.Now.Minute</b> </li>
                                        </ul>
                                    </div>
                                }

                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="text-right">
                                <a v-on:Click="marcarSalida" class="btn btn-sm btn-default">
                                    <i class="fas fa-save"></i>&nbsp; Registrar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- -->
    </div>
    <!-- /.card -->

</section>
@section Scripts {
    <script language="javascript">
        $(document).ready(function () {
            //Cada 10 segundos (10000 milisegundos) se ejecutará la función refrescar
            setTimeout(refrescar, 60000);
        });
        function refrescar() {
            //Actualiza la página
            location.reload();
        }
        //Notificaciones
        var Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000
        });

        //Vuee
        var vform = new Vue({
            el: '#asistencia',
            data: {
                FechaAsistencia:'',
                HoraEntrada:'',
                HoraAlmuerzo: '',
                HoraAlmuerzoRegreso: '',
                HoraSalida: ''
            },
            created() {
                var _this = this;
                fetch('/Asistencia/ConsultaMarcacion',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(result => result.json())
                    .then(function (result) {
                        if (result.success == true) {
                            _this.FechaAsistencia = result.fechaAsistencia;
                            _this.HoraEntrada = result.horaEntrada;
                            _this.HoraAlmuerzo = result.horaAlmuerzo;
                            _this.HoraAlmuerzoRegreso = result.horaAlmuerzoRegreso;
                            _this.HoraSalida = result.horaSalida;
                        }
                        console.log(result.horaEntrada);
                    });
            },
            methods: {
                consultaAsistencia:()=> {
            var _this = this;
            fetch('/Asistencia/ConsultaMarcacion',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(result => result.json())
                .then(function (result) {
                    if (result.success == true) {
                                _this.FechaAsistencia = result.fechaAsistencia;
                                _this.HoraEntrada = result.horaEntrada;
                                _this.HoraAlmuerzo = result.horaAlmuerzo;
                                _this.HoraAlmuerzoRegreso = result.horaAlmuerzoRegreso;
                                _this.HoraSalida = result.horaSalida;
                    }
                });
        },
        marcarAsistencia: () => {
            fetch('/Asistencia/InsertEntrada',
                {
                    method: 'POST',
                    //body: JSON.stringify(body),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(result => result.json())
                .then(function (result) {
                    if (result.success == true && result.insert == true) {
                        toastr.success('Se registró tu entrada correctamente');
                        this.consultaAsistencia();
                        //$(".entrada").prop('disabled', true);
                    } else if (result.success == true && result.insert == false) {
                        toastr.warning('Ya se registró la entrada');
                    }
                });
        },
            marcarAlmuerzo: () => {
                fetch('/Asistencia/InsertAlmuerzo',
                    {
                        method: 'POST',
                        //body: JSON.stringify(body),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(result => result.json())
                    .then(function (result) {
                        if (result.success == true && result.insert == true) {
                            toastr.success('Se registró su salida a almorzar correctamente');
                            //$(".entrada").prop('disabled', true);
                        } else if (result.success == true && result.insert == false) {
                            toastr.warning('Ya se registró el almuerzo o aún falta registrar el ingreso');
                        }
                    });
            },
                marcarAlmuerzoRegreso: () => {
                    fetch('/Asistencia/InsertAlmuerzoRegreso',
                        {
                            method: 'POST',
                            //body: JSON.stringify(body),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true && result.insert == true) {
                                toastr.success('Se registró su regreso a almorzar correctamente');
                                //$(".entrada").prop('disabled', true);
                            } else if (result.success == true && result.insert == false) {
                                toastr.warning('Ya se registró el regreso de almuerzo o aún falta registrar el ingreso');
                            }
                        });
                },
                    marcarSalida: () => {
                        fetch('/Asistencia/InsertSalida',
                            {
                                method: 'POST',
                                //body: JSON.stringify(body),
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(result => result.json())
                            .then(function (result) {
                                if (result.success == true && result.insert == true) {
                                    toastr.success('Se registró su salida correctamente');
                                    //$(".entrada").prop('disabled', true);
                                } else if (result.success == true && result.insert == false) {
                                    toastr.warning('Ya se registró la salida o aún falta registrar el ingreso');
                                }
                            });
                    }
                    },
        filters: {
            JsonFecha(val) {
                return val != null ?
                    moment(val).format('DD/MM/YYYY hh:mm:ss') :
                    'Indeterminado'
                    ;
            },
            JsonFecha2(val) {
                return val != null ?
                    moment(val).format('DD/MM/YYYY') :
                    'Indeterminado'
                    ;
            }
        }
                });

    </script>
}

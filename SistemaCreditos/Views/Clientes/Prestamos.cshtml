@{
    ViewData["Title"] = "Prestamos";
}
@model SistemaCreditos.Models.Cliente

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Préstamos</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Inicio</a></li>
                    <li class="breadcrumb-item active">Lista de Préstamos</li>
                </ol>
            </div>
        </div>
    </div><!-- /.container-fluid -->
</section>

<section class="content" id="prestamos">
    <div class="row">
        <div class="col-md-12">
            <!-- Preloader -->
            <div class="preloader flex-column justify-content-center align-items-center">
                <img class="animation__shake" src="~/img/logocd.jpeg" alt="AdminLTELogo" height="180" width="180">
            </div>

            <div class="card card-outline card-info">
                <div class="card-header">
                    @if (Model != null)
                    {
                        <div><span><font size="5">Cliente : <strong> @Model.ApellidosCliente  @Model.NombreCliente</strong></font>  </span></div>
                        <div><span><font size="4">DNI : <strong> @Model.Dni</strong></font>  </span></div>
                    }
                    @if (Model != null)
                    {
                        <a class="badge bg-success" :href="'/Clientes/NuevoPrestamo?IdCliente='+idCliente" title="Nuevo Préstamo">
                            <i class="fas fa-money-bill-alt"></i><span>  Nuevo Préstamo</span>
                        </a>
                    }
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                     <!-- /.table PRESTAMOS -->
                    <table class="table table-bordered" id="example1">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>ID Préstamo</th>
                                <th>Ver Cuotas</th>
                                <th>Ver Estado de Cuenta</th>
                                <th>Refinanciar / Aplazar</th>
                                <th>Capital</th>
                                <th>Día de pago</th>
                                <th>Fondo Provicionario</th>
                                <th>Fecha de Entrega</th>
                                <th>Fecha de Termino</th>
                                <th>Número de cuotas</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item,numero in prestamos">
                                <td>{{numero+1}}</td>
                                <td>{{item.idPrestamo}}</td>
                                <td class="text-center"><button class="btn btn-default" id="show-modal" data-toggle="modal" data-target="#modal-lg" v-on:Click="verCuotas(item.idPrestamo)"><i class="fas fa-share text-success"></i> <i class="fas fa-list text-success"></i></button></td>
                                <td class="text-center"><button title="Descargar Estado de cuenta" v-on:click="verEstado(item)" id="show-modal-estado" data-toggle="modal" data-target="#modal-estado" class="btn btn-default"><i class="fas fa-file-download text-primary fa-2x"></i></button></td>
                                <td class="text-center"><button title="Aplazar Préstamo" v-on:click="aplazar(item.idPrestamo)" class="btn btn-default" data-toggle="modal" data-target="#modal-aplazar"><i class="far fa-calendar-plus fa-2x text-danger"></i></button></td>
                                <td>{{item.capital}}</td>
                                <td>{{item.diaPago}}</td>
                                <td>{{item.fondoProvicional}}</td>
                                <td>{{item.fechaEntrega | JsonFecha2}}</td>
                                <td>{{item.fechaTermino | JsonFecha2}}</td>
                                <td>{{item.numeroCuotas}}</td>
                            </tr>
                        </tbody>
                    </table>
                    <!-- /.modal-VER CUOTAS -->
                    <div class="modal fade" id="modal-lg">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title text-success">Ver Cuotas</h4>
                                    <button type="button" class="close" v-on:click="window.location.href='/Clientes/Prestamos?id='+idCliente" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body" style="overflow-y: auto; overflow-x: auto;">
                                    <table class="table table-bordered" id="example2">
                                        <thead>
                                            <tr>
                                                <th>Número</th>
                                                <th>Monto de cuota</th>
                                                <th>Fecha de Cuota</th>
                                                <th>Fecha de Pago</th>
                                                <th>Abonar</th>
                                                <th>Modificar Cuota</th>
                                                <th>Lista Abonos</th>
                                                <th>Mora</th>
                                                <th>Días de Mora</th>
                                                <th>Observaciones</th>
                                                <th>Abonos</th>
                                                <th>Pago de Moras</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="item,numero in cuotas">
                                                <td>{{numero+1}}</td>
                                                <td>{{item.montoCuota}}</td>
                                                <td>{{item.fechaCuota | JsonFecha2}}</td>
                                                <td>{{item.fechaPago | JsonFecha2}}</td>
                                                <td v-if="item.fechaPago==null"><button class="btn btn-default" id="show-modal" data-toggle="modal" data-target="#modal-sm" v-on:Click="verAbonar(item.idCuota)"><i class="fas fa-share text-primary"></i> <i class="fab fa-cc-visa text-primary"></i></button></td>
                                                <td v-else><span class="badge bg-success">Cuota Cancelada</span></td>
                                                <td><button class="btn btn-default" id="show-modal-m" data-toggle="modal" data-target="#modal-modificar-cuotas" v-on:Click="verModificarCuota(item.idCuota)"><i class="fas fa-share text-warning"></i> <i class="fas fa-edit text-warning"></i></button></td>
                                                <td v-if="item.abono!=0"><button class="btn btn-default" id="show-modal" data-toggle="modal" data-target="#listar-abonos" v-on:Click="listarAbonos(item.idCuota)"><i class="fas fa-share text-default"></i> <i class="fas fa-list-ol text-default"></i></button></td>
                                                <td v-else><span></span></td>
                                                <td>{{item.mora}}</td>
                                                <td>{{item.diasMora}}</td>
                                                <td>{{item.observaciones}}</td>
                                                <td>{{item.abono}}</td>
                                                <td>{{item.abonoMora}}</td>
                                                
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="modal-footer justify-content-between">
                                    <button type="button" class="btn btn-default" v-on:click="window.location.href='/Clientes/Prestamos?id='+idCliente">Cerrar</button>
                                </div>
                            </div>
                            <!-- /.modal-content -->
                        </div>
                        <!-- /.modal-dialog -->
                    </div>

                    <!-- /.modal-ABONAR -->
                    <div class="modal fade" id="modal-sm">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title text-success">Abonar</h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <label for="exampleSelectBorder">Monto Cuota</label>
                                            <input v-model="form.monto" type="number" class="form-control" maxlength="100" />
                                        </div>
                                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <label for="exampleSelectBorder">Fecha de abono</label>
                                            <input type="date" v-model="form.fechaAbono" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <label for="exampleSelectBorder">Tipo de abono</label>
                                            <select v-model="form.tipoAbono" class="custom-select form-control-border">
                                                <option value="" disabled selected>--Selecione--</option>
                                                <option value="1">VOUCHER</option>
                                                <option value="2">RECIBO</option>
                                            </select>
                                        </div>
                                        <div v-if="form.tipoAbono!=null" class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <label v-if="form.tipoAbono=='1'" for="exampleSelectBorder">Nro Voucher</label>
                                            <label v-if="form.tipoAbono=='2'" for="exampleSelectBorder">Nro Recibo</label>
                                            <input v-model="form.numeroVoucher" type="text" class="form-control" maxlength="100" />
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div v-if="form.tipoAbono=='1'" class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <label for="exampleSelectBorder">Banco</label>
                                            <select v-model="form.banco" class="custom-select form-control-border">
                                                <option value="" disabled selected>--Selecione--</option>
                                                <option v-for="(sel,cix) in bancos" :value="sel.idBanco">{{sel.razonSocial}}</option>
                                            </select>
                                        </div>
                                        <div v-if="form.tipoAbono=='2'" class="form-group col-lg-4 col-md-6 col-sm-12">
                                            <label for="exampleSelectBorder">Gestor</label>
                                            <select class="custom-select form-control-border" v-model="form.gestor">
                                                <option v-for="item in gestores" :value="item.codigoTrabajador" :key="item.codigoTrabajador">
                                                    {{item.nombres}}
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <label for="exampleSelectBorder">Voucher</label>
                                            <input id="voucher" v-model="form.voucher" type="file" class="form-control" maxlength="100" />
                                        </div>
                                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <label for="exampleSelectBorder">Mora</label>
                                            <input v-model="form.mora" type="number" class="form-control" maxlength="100" />
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer justify-content-between">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                                    <button type="submit" class="btn btn-primary" v-on:Click="guardarCuota" :disabled="disabledBtn"><i class="fa fa-save"></i> &nbsp; Guardar</button>
                                </div>
                            </div>
                            <!-- /.modal-content -->
                        </div>
                        <!-- /.modal-dialog -->
                    </div>

                    <!-- /.modal-ESTADO DE CUENTA -->
                    <div class="modal fade" id="modal-estado">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title text-success">Estado de Cuenta</h4>
                                    <div>
                                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                        <button title="Descargar Estado de cuenta" class="btn btn-default" v-on:Click="descargarEstado()">
                                            Descargar &nbsp;
                                            <i class="fas fa-file-download text-success fa-2x"></i>
                                        </button>
                                    </div>
                                    <button type="button" class="close" v-on:click="window.location.href='/Clientes/Prestamos?id='+idCliente" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body" style="overflow-y: auto; overflow-x: auto;">
                                    <table class="table table-bordered" id="estado">
                                        <thead></thead>
                                        <tbody>
                                            @*Datos del Cliente - prestamo*@
                                            <tr>
                                                <td align="center" colspan="9" style="vertical-align: middle;background-color:royalblue;color:white"><b>DATOS DEL CLIENTE</b></td>
                                            </tr>
                                            <tr>
                                                <td colspan="4" rowspan="2" align="center" style="vertical-align: middle;"><label class="badge bg-primary">CREDITOS "DIEGO"</label></td>
                                                <td colspan="3"><b>N° de Créditos</b></td>
                                                <td colspan="2">{{prestamos.length}}</td>
                                            </tr>
                                            <tr>
                                                <td>@Model.CodigoCliente</td>
                                                <td>{{verPrestamo.autorizacion}}</td>
                                                <td>{{verPrestamo.codigoGestor}}</td>
                                                <td>{{verPrestamo.capital}}</td>
                                                <td colspan="2" rowspan="4" align="center" style="vertical-align: middle;">{{verPrestamo.diaPago}}</td>
                                            </tr>
                                            <tr>
                                                <td>Nombre: </td>
                                                <td colspan="5"><b>@Model.NombreCliente @Model.ApellidosCliente</b></td>
                                                <td colspan="2">HCL</td>
                                            </tr>
                                            <tr>
                                                <td>Dirección: </td>
                                                <td colspan="7"><b>@Model.Direccion</b></td>
                                            </tr>
                                            <tr>
                                                <td>Telefonos: </td>
                                                <td><b>@Model.Celular</b></td>
                                                <td>Celular: </td>
                                                <td><b>@Model.Celular</b></td>
                                                <td>DNI: </td>
                                                <td colspan="3"><b>@Model.Dni</b></td>
                                            </tr>
                                            <tr>
                                                <td>Ubicación: </td>
                                                <td colspan="8"><b>@Model.UbicacionReferencia</b></td>
                                            </tr>
                                            <tr>
                                                <td>Trabajo: </td>
                                                <td colspan="8"><b>@Model.TrabajoOcupacion</b></td>
                                            </tr>
                                            <tr>
                                                <td colspan="9">&nbsp;</td>
                                            </tr>
                                            @*Datos del conyuge*@
                                            @if(Model.TieneConyuge>0){
                                            <tr>
                                                <td>Conyuge: </td>
                                                <td colspan="5"><b>@Model.NombreConyuge @Model.ApellidosConyuge</b></td>
                                                <td>DNI: </td>
                                                <td colspan="2"><b>@Model.DniConyuge</b></td>
                                            </tr>
                                            <tr>
                                                <td>Dirección Conyuge: </td>
                                                <td colspan="8"><b>@Model.DireccionConyuge</b></td>
                                            </tr>
                                            <tr>
                                                <td>Trabajo: </td>
                                                <td colspan="5"><b>@Model.TrabajoConyuge</b></td>
                                                <td>Telefono: </td>
                                                <td colspan="2"><b>@Model.TelefonoConyuge</b></td>
                                            </tr>
                                            <tr>
                                                <td colspan="9">&nbsp;</td>
                                            </tr>
                                            }
                                            @*Datos de AVal*@
                                            @if(Model.TieneAval>0){
                                            <tr>
                                                <td>Aval: </td>
                                                <td colspan="5"><b>@Model.NombreAval @Model.ApellidosAval</b></td>
                                                <td>DNI: </td>
                                                <td colspan="2"><b>@Model.DniAval</b></td>
                                            </tr>
                                            <tr>
                                                <td>Dirección Aval: </td>
                                                <td colspan="8"><b>@Model.DireccionAval</b></td>
                                            </tr>
                                            <tr>
                                                <td>Trabajo Aval: </td>
                                                <td colspan="5"><b>@Model.TrabajoAval</b></td>
                                                <td>Telefono Aval: </td>
                                                <td colspan="2"><b>@Model.TelefonoAval</b></td>
                                            </tr>
                                            <tr>
                                                <td>Parentesco: </td>
                                                <td colspan="5"><b>@Model.ParentescoAval</b></td>
                                                <td>Hijos: </td>
                                                <td colspan="2"><b>@Model.Hijos</b></td>
                                            </tr>
                                            <tr>
                                                <td colspan="9">&nbsp;</td>
                                            </tr>
                                            }
                                            @*Estado de cuenta*@
                                            <tr>
                                                <td colspan="9" style="vertical-align: middle;background-color:royalblue;color:white" align="center"><b>ESTADO DE CUENTA</b></td>
                                            </tr>
                                            <tr>
                                                <td>Fecha de Entrega: </td>
                                                <td><b>{{verPrestamo.fechaEntrega | JsonFecha2}}</b></td>
                                                <td>Modalidad: </td>
                                                <td><b>{{verPrestamo.numeroCuotas}}</b></td>
                                                <td colspan="2">Capital: </td>
                                                <td><b>{{verPrestamo.capital}}</b></td>
                                                <td>Fondo Provisional: </td>
                                                <td><b>{{verPrestamo.fondoProvisional}}</b></td>

                                            </tr>
                                            <tr>
                                                <td colspan="1">Capital pendiente Inicial: </td>
                                                <td colspan="2"><b>{{verPrestamo.capitalPendiente}}</b></td>
                                                <td colspan="2">Número de créditos: </td>
                                                <td colspan="1"><b>{{prestamos.length}}</b></td>
                                                <td colspan="1">Días de pago: </td>
                                                <td colspan="3"><b>{{verPrestamo.diaPago}}</b></td>
                                            </tr>
                                            <tr>
                                                <td colspan="9">
                                                    <table>
                                                        <thead>
                                                            <tr>
                                                                <td>IT</td>
                                                                <td>FECHA</td>
                                                                <td>CAPITAL</td>
                                                                <td>ABONO</td>
                                                                <td>CAPITAL PENDIENTE</td>
                                                                <td>ABONO MORA</td>
                                                                <td>G</td>
                                                                <td>FECHA PAGO</td>
                                                                <td>N° OPERACIÓN</td>
                                                                <td>BANCO</td>
                                                                <td>MORAS PENDIENTES</td>
                                                                <td>DÍAS MORA</td>
                                                                <td>OBSERVACIÓN</td>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="i,numero in cuotas">
                                                                <td>{{numero+1}}</td>
                                                                <td>{{i.fechaCuota | JsonFecha2}}</td>
                                                                <td>{{verPrestamo.capital}}</td>
                                                                <td>{{i.abono}}</td>
                                                                <td>{{verPrestamo.capitalPendiente}}</td>
                                                                <td>{{i.abonoMora}}</td>
                                                                <td>-</td>
                                                                <td>{{i.fechaPago | JsonFecha2}}</td>
                                                                <td>{{i.nroOperacion}}</td>
                                                                <td>{{i.banco}}</td>
                                                                <td>{{i.mora}}</td>
                                                                <td>{{i.diasMora}}</td>
                                                                <td>{{i.observaciones}}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>S+</th>
                                                                <td></td>
                                                                <td></td>
                                                                <th>{{estadoCuenta.abonoTotal}}</th>
                                                                <td></td>
                                                                <th>{{estadoCuenta.abonoMoraTotal}}</th>
                                                                <td></td>
                                                                <td></td>
                                                                <td></td>
                                                                <td></td>
                                                                <th>{{estadoCuenta.moraTotal}}</th>
                                                                <th>{{estadoCuenta.diasMoraTotal}}</th>
                                                                <td></td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="modal-footer justify-content-between">
                                    <button type="button" class="btn btn-default" v-on:click="window.location.href='/Clientes/Prestamos?id='+idCliente">Cerrar</button>
                                    <div>
                                        <button title="Descargar Estado de cuenta" class="btn btn-default" v-on:Click="descargarEstado()">
                                            Descargar &nbsp;
                                            <i class="fas fa-file-download text-success fa-2x"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- /.modal-content -->
                        </div>
                        <!-- /.modal-dialog -->
                    </div>
                </div>

                <div class="card-footer">
                    <div class="text-center">
                        <a asp-controller="Clientes" asp-action="ListaClientes"><i class="fa fa-reply"></i> &nbsp; Atrás</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @*Mantenimiento Abonos*@
    <!-- /.modal-Listar Abonos -->
    <div class="modal fade" id="listar-abonos">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title text-primary">Listado de Abonos de la cuota</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered" id="listaAbonos">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Monto Abono</th>
                                <th>Fecha de Abono</th>
                                <th>Usuario de Registro</th>
                                <th>Editar</th>
                                <th>Eliminar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item,numero in listaAbonos">
                                <td>{{numero+1}}</td>
                                <td>{{item.montoAbono}}</td>
                                <td>{{item.fechaAbono | JsonFecha2}}</td>
                                <td>{{item.usuarioIngresa}}</td>
                                <td><button class="btn btn-default" id="show-modal" data-toggle="modal" data-target="#editar-abono" v-on:Click="editarAbono(item.idAbono)"><i class="fas fa-share text-warning"></i> <i class="fas fa-edit text-warning"></i></button></td>
                                <td><button class="btn btn-default" v-on:Click="eliminarAbono(item.idAbono)"><i class="fas fa-trash text-danger"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal- Editar ABONAR -->
    <div class="modal fade" id="editar-abono">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title text-warning">Editar Abono</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Monto Cuota</label>
                            <input v-model="formu.monto" type="number" class="form-control" maxlength="100" />
                        </div>
                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Fecha de abono</label>
                            <input type="date" v-model="formu.fechaAbono" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Tipo de abono</label>
                            <select v-model="formu.tipoAbono" class="custom-select form-control-border">
                                <option value="" disabled selected>--Selecione--</option>
                                <option value="1">VOUCHER</option>
                                <option value="2">RECIBO</option>
                            </select>
                        </div>
                        <div v-if="formu.tipoAbono!=null" class="form-group col-lg-6 col-md-6 col-sm-12">
                            <label v-if="formu.tipoAbono=='1'" for="exampleSelectBorder">Nro Voucher</label>
                            <label v-if="formu.tipoAbono=='2'" for="exampleSelectBorder">Nro Recibo</label>
                            <input v-model="formu.numeroVoucher" type="text" class="form-control" maxlength="100" />
                        </div>
                    </div>
                    <div class="row">
                        <div v-if="formu.tipoAbono=='1'" class="form-group col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Banco</label>
                            <select v-model="formu.banco" class="custom-select form-control-border">
                                <option value="" disabled selected>--Selecione--</option>
                                <option v-for="(sel,cix) in bancos" :value="sel.idBanco">{{sel.razonSocial}}</option>
                            </select>
                        </div>
                        <div v-if="formu.tipoAbono=='2'" class="form-group col-lg-4 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Gestor</label>
                            <select class="custom-select form-control-border" v-model="formu.gestor">
                                <option v-for="item in gestores" :value="item.codigoTrabajador" :key="item.codigoTrabajador">
                                    {{item.nombres}}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Voucher</label>
                            <input id="voucher" v-model="formu.voucher" type="file" class="form-control" maxlength="100" />
                        </div>
                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Mora</label>
                            <input v-model="formu.mora" type="number" class="form-control" maxlength="100" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary" v-on:Click="guardarCuotaModificada" :disabled="disabledBtn"><i class="fa fa-save"></i> &nbsp; Guardar</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    @*Fin antenimiento Abonos*@

    @*Mantenimiento Prestamos*@
    <div class="modal fade" id="modal-aplazar">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title text-primary">Aplazar Préstamo</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-4 col-md-6 col-sm-12">
                            <span><font size="4">Id Prestamo : <strong>{{formAplazar.idPrestamo}} </strong></font></span>
                        </div>
                        <div class="col-lg-2 col-sm-12">

                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Nueva Fecha: </label>
                            <input type="date" v-model="formAplazar.fecha" class="form-control" maxlength="250" />
                        </div>
                    </div>

                    <div class="row">
                        
                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Monto de Cuotas</label>
                            <input type="number" v-model="formAplazar.montoCuotas" class="form-control" maxlength="10"/>
                        </div>
                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Número de cuotas</label>
                            <input type="number" v-model="formAplazar.numeroCuotas" class="form-control" maxlength="2" />
                        </div>
                    </div>
                    <div class="row">

                        <div class="form-group col-lg-4 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Día de Pago</label>
                            <select v-model="formAplazar.diaPago" class="custom-select form-control-border" required>
                                <option v-for="(sel,cix) in dias" :value="sel.id">{{sel.text}}</option>
                                <option selected="true" value="" disabled>Seleccione...</option>
                            </select>
                        </div>
                    </div>

                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary" v-on:Click="guardarAplazar()" :disabled="disabledBtn"><i class="fa fa-save"></i> &nbsp; Guardar</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    @*Fin Mantenimiento Prestamos*@

    @*Mantenimiento Cuotas*@
    <div class="modal fade" id="modal-modificar-cuotas">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title text-warning">Modificar Cuota</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Fecha Cuota: </label>
                            <input type="date" v-model="formModCuota.fechaCuota" class="form-control" maxlength="250" />
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Fecha Pago: </label>
                            <input type="date" v-model="formModCuota.fechaPago" class="form-control" maxlength="250" />
                        </div>
                    </div>

                    <div class="row">

                        <div class="form-group col-lg-4 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Monto de Cuota</label>
                            <input type="number" v-model="formModCuota.montoCuota" class="form-control" maxlength="10" />
                        </div>
                         <div class="form-group col-lg-4 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Días de Mora</label>
                            <input type="number" v-model="formModCuota.diasMora" class="form-control" maxlength="10" />
                        </div>
                        <div class="form-group col-lg-4 col-md-6 col-sm-12">
                            <label for="exampleSelectBorder">Mora</label>
                            <input type="number" v-model="formModCuota.mora" class="form-control" maxlength="10" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-lg-12 col-md-12 col-sm-12">
                            <label for="exampleSelectBorder">Observaciones</label>
                            <textarea v-model="formModCuota.observaciones" type="text" class="form-control" maxlength="1500" rows="3"></textarea>
                        </div>
                    </div>

                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary" v-on:Click="guardarModificarCuota()" :disabled="disabledBtn"><i class="fa fa-save"></i> &nbsp; Guardar</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    @*Mantenimiento Cuotas*@
</section>
@section Scripts {
    <script src="~/adminLte/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="~/adminLte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/adminLte/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/adminLte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script src="~/adminLte/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/adminLte/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
    <script src="~/adminLte/plugins/jszip/jszip.min.js"></script>
    <script src="~/adminLte/plugins/pdfmake/pdfmake.min.js"></script>
    <script src="~/adminLte/plugins/pdfmake/vfs_fonts.js"></script>
    <script src="~/adminLte/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
    <script src="~/adminLte/plugins/datatables-buttons/js/buttons.print.min.js"></script>
    <script src="~/adminLte/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
    <script language="javascript">
        function refrescar() {
            location.reload();
        }
        //Funcion para covertir a base 64
        function getBase64(file) {
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function () {
                let documento = reader.result.replace(/^data:.+;base64,/, '');
                vform.form.voucher = documento;
            }
        }
        async function cargarFile(file) {
            await getBase64(file);
        }
        //Vuee
        var vform = new Vue({
            el: '#prestamos',
            data: {
                dias: [
                    { id: 'LUNES', text: 'LUNES' },
                    { id: 'MARTES', text: 'MARTES' },
                    { id: 'MIERCOLES', text: 'MIERCOLES' },
                    { id: 'JUEVES', text: 'JUEVES' },
                    { id: 'VIERNES', text: 'VIERNES' },
                    { id: 'SABADO', text: 'SABADO' },
                    { id: 'DOMINGO', text: 'DOMINGO' },

                ],
                prestamos: [],
                idCliente: '@Model.IdCliente',
                showModal: false,
                cuotas: [],
                form:[],
                formu: {
                    idAbono : '',
                    monto : '',
                    fechaAbono: '',
                    banco :'',
                    numeroVoucher: '',
                    tipoAbono : '',
                    mora: '',
                    gestor: ''
                },
                bancos: [],
                idCuota: '',
                disabledBtn: false,
                estadoCuenta:[],
                verPrestamo:'',
                gestores: [],
                listaAbonos:[],
                formAplazar:{
                    idPrestamo:'',
                    fecha:''
                },
                formModCuota: {
                    idCuota:'',
                    fechaCuota:'',
                    fechaPago:'',
                    montoCuota:'',
                    cantidadAbonos:'',
                    mora:'',
                    diasMora:'',
                    observaciones:''
                }
            },
            created() {
                var _this = this;
                fetch('/Clientes/Gestores',
                    {
                        method: 'POST',
                        body: '',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(result => result.json())
                    .then(function (result) {
                        if (result.success == true) {
                            _this.gestores = result.gestores;
                        }
                    });
                fetch('/Clientes/Bancos',
                    {
                        method: 'POST',
                        //body: JSON.stringify(cliente),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(result => result.json())
                    .then(function (result) {
                        if (result.success == true) {
                            _this.bancos = result.bancos;
                        }
                    });

                var id = '@Model' != null ? '@Model.IdCliente' : 0;
                fetch('/Clientes/ListaPrestamos?idCliente=' + id,
                    {
                        method: 'POST',
                        body: '',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(result => result.json())
                    .then(function (result) {
                        if (result.success == true) {
                            _this.prestamos = result.prestamos;
                        }
                        $(function () {
                            $("#example1").DataTable({
                                "responsive": true, "lengthChange": false, "autoWidth": false,
                                "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"],
                                language: {
                                    "sProcessing": "Procesando...",
                                    "sLengthMenu": "Mostrar _MENU_ registros",
                                    "sZeroRecords": "No se encontraron resultados",
                                    "sEmptyTable": "Ningún dato disponible en esta tabla",
                                    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_",
                                    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                                    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                                    "sInfoPostFix": "",
                                    "sSearch": "Buscar:",
                                    "sUrl": "",
                                    "sInfoThousands": ",",
                                    "sLoadingRecords": "Cargando...",
                                    "oPaginate": {
                                        "sFirst": "Primero",
                                        "sLast": "Último",
                                        "sNext": "Siguiente",
                                        "sPrevious": "Anterior"
                                    },
                                    "oAria": {
                                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                                    },
                                    "buttons": {
                                        "copy": "Copiar",
                                        "colvis": "Visibilidad"
                                    }
                                }
                            }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');

                        });
                    });

            },
            methods: {
                verAbonar(idCuota) {
                    vform.idCuota = idCuota;
                },
                listarAbonos(idCuota) {
                    var this_ = this;
                    vform.idCuota = idCuota;
                    fetch('/Clientes/ListarAbonos?idCuota=' + idCuota,
                        {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true) {
                                _this.listaAbonos = result.listaAbonos;
                            }
                        });
                },
                editarAbono(idAbono) {
                    fetch('/Clientes/VerAbono?idAbono=' + idAbono,
                        {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true) {
                                vform.formu.idAbono = result.verAbono.idAbono;
                                vform.formu.monto = result.verAbono.montoAbono;
                                vform.formu.fechaAbono = result.verAbono.fechaAbono;
                                vform.formu.banco = result.verAbono.banco;
                                vform.formu.numeroVoucher = result.verAbono.codigo;
                                vform.formu.tipoAbono = result.verAbono.tipoAbono;
                                vform.formu.mora = result.verAbono.montoMora;
                                vform.formu.gestor = result.verAbono.codigoGestor;
                            }
                        });
                },
                guardarCuotaModificada(idAbono) {
                    var _this = this;
                    _this.disabledBtn = true;
                    //serializar formulario abono
                    var abono = Object.assign({}, vform.formu);
                    abono.idCuota = vform.idCuota;
                    console.log(abono)
                    //abono.idAbono = vform.idAbono;
                    fetch('/Clientes/ModificarAbono',
                        {
                            method: 'POST',
                            body: JSON.stringify(abono),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true) {
                                setTimeout(refrescar, 1500);
                                toastr.success('¡Se modificó correctamente el abono!');
                            }
                        });
                },
                eliminarAbono(idAbono) {
                    var _this = this;
                    _this.disabledBtn = true;
                    //serializar formulario abono
                    fetch('/Clientes/EliminarAbono?idAbono=' + idAbono,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true) {
                                setTimeout(refrescar, 1500);
                                toastr.success('¡Se eliminó correctamente el abono!');
                            }
                        });
                },
                guardarCuota() {
                    var _this = this;
                    _this.disabledBtn = true;
                    //serializar formulario abono
                    var abono = Object.assign({}, vform.form);
                    abono.idCuota = vform.idCuota;
                    fetch('/Clientes/NuevoAbono',
                        {
                            method: 'POST',
                            body: JSON.stringify(abono),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true) {
                                setTimeout(refrescar, 1500);
                                toastr.success('¡Se registró correctamente el abono!');
                            }
                        });
                },
                verCuotas: (idPrestamo) => {
                    fetch('/Clientes/Cuotas?idPrestamo=' + idPrestamo,
                        {
                            method: 'POST',
                            //body: JSON.stringify(request),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true) {
                                vform.cuotas = result.cuotas;
                                $(function () {
                                    $("#example2").DataTable({
                                        //paging: false,
                                        retrieve: true,
                                        bDestroy: true,
                                        "responsive": true, "lengthChange": true, "autoWidth": false,
                                        "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"],
                                        language: {
                                            "sProcessing": "Procesando...",
                                            "sLengthMenu": "Mostrar _MENU_ registros",
                                            "sZeroRecords": "No se encontraron resultados",
                                            "sEmptyTable": "Ningún dato disponible en esta tabla",
                                            "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_",
                                            "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                                            "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                                            "sInfoPostFix": "",
                                            "sSearch": "Buscar:",
                                            "sUrl": "",
                                            "sInfoThousands": ",",
                                            "sLoadingRecords": "Cargando...",
                                            "oPaginate": {
                                                "sFirst": "Primero",
                                                "sLast": "Último",
                                                "sNext": "Siguiente",
                                                "sPrevious": "Anterior"
                                            },
                                            "oAria": {
                                                "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                                                "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                                            },
                                            "buttons": {
                                                "copy": "Copiar",
                                                "colvis": "Visibilidad"
                                            }
                                        }
                                    }).buttons().container().appendTo('#example2_wrapper .col-md-6:eq(0)');
                                });
                            }
                        });
                },
                verEstado:(prestamo)=>{
                    vform.verPrestamo=prestamo;
                    fetch('/Clientes/EstadoCuenta?idPrestamo=' + prestamo.idPrestamo,
                        {
                            method: 'POST',
                            //body: '',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true) {
                                vform.estadoCuenta = result;
                                vform.cuotas = result.cuotas;
                                console.log(prestamo)
                                console.log(vform.cuotas)
                                console.log('@Model.NombreCliente')
                            }
                        });
                },
                descargarEstado() {
                    var BOM = "\uFEFF";
                    var htmltabel = document.getElementById("estado");
                    var html = htmltabel.outerHTML;
                    window.open('data:application/vnd.ms-excel,' + encodeURI(BOM + html));
                },
                aplazar(idPrestamo) {
                    vform.formAplazar.idPrestamo=idPrestamo;
                },
                guardarAplazar(){
                    var _this = this;
                    _this.disabledBtn = true;
                    //serializar formulario abono
                    var abono = Object.assign({}, vform.formAplazar);
                    fetch('/Clientes/GuardarAplazar',
                        {
                            method: 'POST',
                            body: JSON.stringify(abono),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true) {
                                setTimeout(refrescar, 1500);
                                toastr.success('¡Se modificó correctamente el abono!');
                            }
                        });
                },
                verModificarCuota(idCuota){
                    vform.idCuota=idCuota;
                    fetch('/Clientes/VerModificarCuota?idCuota=' + idCuota,
                        {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true) {
                                vform.formModCuota.idCuota = result.cuota.idCuota;
                                vform.formModCuota.fechaCuota = result.cuota.fechaCuota;
                                vform.formModCuota.fechaPago = result.cuota.fechaPago;
                                vform.formModCuota.montoCuota = result.cuota.montoCuota;
                                vform.formModCuota.cantidadAbonos = result.cuota.cantidadAbonos;
                                vform.formModCuota.mora = result.cuota.mora;
                                vform.formModCuota.diasMora = result.cuota.diasMora;
                                vform.formModCuota.observaciones = result.cuota.observaciones;
                            }
                        });
                },
                guardarModificarCuota() {
                    var _this = this;
                    _this.disabledBtn = true;

                    //serializar formulario abono
                    var cuota = Object.assign({}, vform.formModCuota);
                    fetch('/Clientes/GuardarCuota',
                        {
                            method: 'POST',
                            body: JSON.stringify(cuota),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(result => result.json())
                        .then(function (result) {
                            if (result.success == true) {
                                setTimeout(refrescar, 1500);
                                toastr.success('¡Se registró correctamente la cuota!');
                            }
                        });
                }
            },
            filters: {
                JsonFecha(val) {
                    return val != null ?
                        moment(val).format('DD/MM/YYYY hh:mm:ss') :
                        ''
                        ;
                },
                JsonFecha2(val) {
                    return val != null ?
                        moment(val).format('DD/MM/YYYY') :
                        ''
                        ;
                }
            },
            beforeUpdate() {
                _this = this;
                //seleccionar si es que hay archivo a guardar
                if (this.form.voucher != '' || this.form.voucher != undefined || this.form.voucher != null) {
                    //Extraer atributos
                    var archivo = $("#voucher").val().split('\\').pop();
                    var extension = archivo.substring(archivo.lastIndexOf("."));
                    this.form.tipo = extension;
                    var file = document.querySelector('#voucher').files[0];
                    //Obtener base 64
                    cargarFile(file);
                }
                if(this.formModCuota.diasMora>0){
                    this.formModCuota.mora=this.formModCuota.diasMora*5;
                }
            }
        });
    </script>
}